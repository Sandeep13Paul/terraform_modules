# version: 3

# repos:
#   - id: github.com/Sandeep13Paul/terraform_modules
#     allowed_overrides: [workflow]
#     allow_custom_workflows: true
#     projects:
#       - dir: project_1
#         workflow: project_1_workflow
#       - dir: project_2
#         workflow: project_2_workflow

# workflows:
#   project_1_workflow:
#     plan:
#       steps:
#         - run: rm -rf .terraform .terraform.lock.hcl
#         - run: |
#             terraform plan \
#               -var="GOOGLE_CREDENTIALS1=$TF_VAR_GOOGLE_CREDENTIALS1" \
#               -var-file="project_1/terraform.tfvars" \
#               -out=tfplan
#     apply:
#       steps:
#         - run: terraform apply -var-file="project_1/terraform.tfvars" tfplan
#         - run: ../scripts/post_apply.sh

#   project_2_workflow:
#     plan:
#       steps:
#         - run: rm -rf .terraform .terraform.lock.hcl
#         - run: |
#             terraform plan \
#               -var="GOOGLE_CREDENTIALS2=$TF_VAR_GOOGLE_CREDENTIALS2" \
#               -var-file="project_2/terraform.tfvars" \
#               -out=tfplan
#     apply:
#       steps:
#         - run: terraform apply -var-file="project_2/terraform.tfvars" tfplan


version: 3

projects:
  - dir: project_1
    workflow: project_1_workflow

  - dir: project_2
    workflow: project_2_workflow

workflows:
  project_1_workflow:
    plan:
      steps:
        - run: rm -rf .terraform .terraform.lock.hcl
        - run: |
            terraform plan \
              -var="GOOGLE_CREDENTIALS1=$TF_VAR_GOOGLE_CREDENTIALS1" \
              -var-file="project_1/terraform.tfvars" \
              -out=tfplan
    apply:
      steps:
        - run: terraform apply -var-file="project_1/terraform.tfvars" tfplan
        - run: ../scripts/post_apply.sh

  project_2_workflow:
    plan:
      steps:
        - run: rm -rf .terraform .terraform.lock.hcl
        - run: |
            terraform plan \
              -var="GOOGLE_CREDENTIALS2=$TF_VAR_GOOGLE_CREDENTIALS2" \
              -var-file="project_2/terraform.tfvars" \
              -out=tfplan
    apply:
      steps:
        - run: terraform apply -var-file="project_2/terraform.tfvars" tfplan
